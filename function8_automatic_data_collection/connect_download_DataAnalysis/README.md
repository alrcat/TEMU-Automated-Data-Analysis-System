# TEMU 数据分析下载自动化工具

## 版本信息

- **当前版本**: v2.4
- **更新日期**: 2025-01-XX

## 版本历史

### v2.4 (最新版本)

#### 主要更新
- ✅ **安全优化**：参考活动报名工具的安全措施，全面优化操作行为，避免被TEMU识别为中国卖家
- ✅ **人类化点击操作**：所有点击操作前先hover，使用随机延迟（50-150ms），点击后随机等待（0.8-2.5秒）
- ✅ **随机延迟优化**：将所有固定延迟改为随机延迟，模拟真实用户操作节奏
- ✅ **操作间隔优化**：增加操作之间的随机延迟，避免过于精确的时间间隔

#### 改进点
- 所有关键点击操作（Analytics、Product analytics、Sales标签、Today按钮、日期选择器、Apply、Download等）都添加了hover操作
- 点击延迟使用随机值（50-150ms），模拟人类点击速度
- 操作后等待时间使用随机范围，避免固定模式
- 提高操作的自然度，降低被检测风险

### v2.3

#### 主要更新
- ✅ **修复Sales页面日期选择器定位问题**：解决Sales页面日期选择器 strict mode violation 错误，使用 `beast-core-datePicker-input` 容器精确定位
- ✅ **优化Sales页面日期选择器点击逻辑**：先尝试点击图标，失败后尝试点击输入框，提高成功率
- ✅ **统一日期选择器处理逻辑**：Sales和Traffic页面都使用相同的日期选择器header定位方式

#### 改进点
- 修复Sales页面日期选择器元素定位冲突问题（找到多个元素）
- 通过容器定位避免strict mode violation错误
- 提高Sales页面日期选择的稳定性

### v2.2

#### 主要更新
- ✅ **修复日期选择器定位问题**：解决左箭头按钮 strict mode violation 错误，使用更精确的选择器
- ✅ **下载重试机制增强**：下载失败后自动重试3次完整流程（Today → 选择日期 → Apply → Download），失败后中止报错
- ✅ **下载超时时间优化**：将下载超时时间从30秒增加到60秒，减少超时失败
- ✅ **Apply 按钮等待优化**：点击 Apply 后固定等待1.5秒，并明确等待 Download 按钮出现
- ✅ **Product analytics 点击逻辑优化**：无论菜单项是否存在，都会点击 Product analytics 按钮
- ✅ **国家选择等待增强**：点击国家选择器后增加等待时间，确保点击生效

#### 改进点
- 修复日期选择器中的元素定位冲突问题
- 提高下载成功率，通过重试机制和超时优化
- 更稳定的页面等待机制，确保按钮出现后再操作

### v2.1

#### 主要更新
- ✅ **添加重试机制**：所有关键按钮点击操作均支持最多3次重试
  - Analytics 菜单点击
  - Product analytics 按钮点击
  - Traffic 标签点击
  - Sales 标签点击
- ✅ **页面加载等待优化**：选择国家后等待页面完全加载（DOM + 网络空闲）
- ✅ **错误处理增强**：移除跳过逻辑，3次重试失败后抛出异常中止程序
- ✅ **多国家循环支持**：根据 `config.py` 中的 `COUNTRY_ORDER` 列表自动循环处理所有国家

#### 改进点
- 提高操作稳定性，减少因网络延迟或页面加载导致的失败
- 更清晰的错误提示和重试日志
- 确保每个步骤成功执行后再进行下一步

### v2.0

#### 初始功能
- 重新使用识别按钮逻辑重写一遍!
- 连接紫鸟浏览器
- 选择指定国家
- 进入 Product analytics 页面
- 下载 Traffic 和 Sales 数据
- 根据历史文件自动计算需要下载的日期范围
- 循环下载指定日期范围的数据

### v1.0 (历史版本)

**位置**: `历史版本/connect_download_DataAnalysis/connect_download_DataAnalysis_v1.0/connect_download_DataAnalysisv/`

#### 初始功能
- 连接紫鸟浏览器
- 选择指定国家
- 进入 Product analytics 页面
- 下载 Traffic 和 Sales 数据
- 根据历史文件自动计算需要下载的日期范围
- 循环下载指定日期范围的数据

## 功能概述

本工具用于自动化下载 TEMU 平台的产品分析数据（Traffic 和 Sales），支持：

- 🔄 **多国家批量处理**：按配置顺序自动处理多个国家
- 📅 **智能日期范围**：根据历史导入目录自动计算需要下载的日期
- 🔁 **循环下载**：对每个日期自动执行下载流程
- 📊 **双数据类型**：同时下载 Traffic 和 Sales 数据
- 🔄 **重试机制**：关键操作失败时自动重试，提高成功率
- 🛡️ **安全优化**：人类化操作模拟，避免被识别为自动化脚本

## 文件结构

```
connect_download_DataAnalysis/
├── main.py                          # 主程序入口
├── select_country.py                # 国家选择功能
├── get_date_range_from_history.py   # 日期范围计算
├── download_for_loop.py              # 循环下载功能
└── README.md                        # 本文件
```

## 依赖配置

### 配置文件 (`config.py`)

需要在项目根目录的 `config.py` 中配置：

```python
# 国家顺序列表
COUNTRY_ORDER = [
    "IT",  # 意大利
    "DE",  # 德国
    "FR",  # 法国
    "NL",  # 荷兰
]

# 下载路径配置
DOWNLOAD_PATHS = {
    "IT": {
        "traffic": r"C:\Users\PC\Desktop\Apis\DataAnalysis\Trafic_vida\PL2_IT",
        "sales": r"C:\Users\PC\Desktop\Apis\DataAnalysis\Sales_vida\PL2_IT_Sales",
    },
    # ... 其他国家配置
}
```

## 使用说明

### 运行主程序

```bash
python connect_download_DataAnalysis/main.py
```

### 工作流程

1. **连接浏览器**
   - 自动连接紫鸟浏览器（通过 CDP 端口）

2. **循环处理每个国家**（按 `COUNTRY_ORDER` 顺序）
   - 选择国家
   - 等待页面加载完成
   - 进入 Product analytics 页面（带重试机制）
   - 点击 Traffic 标签（带重试机制）
   - 循环下载 Traffic 数据
   - 点击 Sales 标签（带重试机制）
   - 循环下载 Sales 数据

3. **每个日期的下载流程**
   - 点击 Today 按钮
   - 打开日期选择器
   - 切换月份（如需要）
   - 选择目标日期
   - 点击 Apply 按钮
   - 点击 Download 按钮并保存文件

## 重试机制说明

### 重试策略

所有关键按钮点击操作均采用以下重试策略：

- **最大重试次数**: 3 次
- **重试间隔**: 1-2 秒随机延迟
- **失败处理**: 3 次重试全部失败后，抛出异常并中止程序

### 支持重试的操作

1. **Analytics 菜单点击**
   - 如果 Product analytics 菜单项不存在，会尝试点击 Analytics 菜单
   - 失败时自动重试 3 次

2. **Product analytics 按钮点击**
   - 点击 Product analytics 菜单项
   - 失败时自动重试 3 次

3. **Traffic 标签点击**
   - 切换到 Traffic 数据页面
   - 失败时自动重试 3 次

4. **Sales 标签点击**
   - 切换到 Sales 数据页面
   - 失败时自动重试 3 次

5. **下载流程重试**（v2.2 新增）
   - 下载失败后，重新执行完整流程（Today → 选择日期 → Apply → Download）
   - 最多重试 3 次完整流程
   - 3 次都失败后抛出异常中止程序

6. **Sales页面日期选择器优化**（v2.3 新增）
   - 使用容器定位避免strict mode violation错误
   - 支持图标和输入框两种点击方式

### 重试日志示例

```
🔍 第 1/3 次尝试：点击 Traffic 标签...
⚠ 第 1 次尝试失败: Timeout 30000ms exceeded
🔍 第 2/3 次尝试：点击 Traffic 标签...
✓ 已点击 Traffic 标签
```

## 页面加载等待机制

### 国家选择后的等待流程

选择国家后，程序会执行以下等待步骤：

1. **点击后立即等待**: 1.5-2.0 秒随机延迟，确保点击生效（v2.2 新增）
2. **基础等待**: 1.0-1.5 秒随机延迟
3. **DOM 加载**: 等待 DOM 内容加载完成（最多 15 秒）
4. **网络空闲**: 等待网络请求完成（最多 15 秒）
5. **额外等待**: 0.5-1.0 秒随机延迟，确保页面完全稳定

### Apply 按钮后的等待流程（v2.2 新增）

点击 Apply 按钮后，程序会执行以下等待步骤：

1. **固定等待**: 1.5 秒固定延迟，确保 Apply 生效
2. **DOM 加载**: 等待 DOM 内容加载完成（最多 15 秒）
3. **网络空闲**: 等待网络请求完成（最多 15 秒，超时不影响继续）
4. **Download 按钮等待**: 明确等待 Download 按钮出现（最多 10 秒）
5. **额外等待**: 0.5-1.0 秒随机延迟，确保页面完全稳定

### 日志输出示例

```
✓ 已选择国家: Italy (IT)
⏳ 等待页面加载完成...
✓ DOM 加载完成
✓ 网络空闲，页面加载完成
```

## 日期范围计算

程序会根据历史导入目录中的 Excel 文件自动计算需要下载的日期范围：

- **起始日期**: 最新历史文件结束日期的下一天
- **结束日期**: 今天的前一天
- **默认起始日期**: 如果历史目录为空，默认从 2025-10-01 开始

### 历史文件命名格式

历史文件应使用以下命名格式：
```
YYYY-MM-DD~YYYY-MM-DD.xlsx
```

例如：`2025-01-01~2025-01-31.xlsx`

## 下载文件命名规则

下载的文件会按照以下规则命名：

```
{国家代码}_{数据类型}_{日期}.xlsx
```

例如：
- `IT_traffic_2025-01-15.xlsx`
- `IT_sales_2025-01-15.xlsx`

## 错误处理

### v2.4 错误处理策略

- ❌ **移除跳过逻辑**：不再跳过失败的操作
- ✅ **重试机制**：关键操作自动重试 3 次
- 🔄 **下载重试**：下载失败后重试3次完整流程（v2.2 新增）
- 🛑 **失败中止**：3 次重试失败后抛出异常，中止程序执行
- ⏱️ **超时优化**：下载超时时间从30秒增加到60秒（v2.2 新增）
- 🎯 **精确定位**：Sales页面使用容器定位避免元素冲突（v2.3 新增）
- 🛡️ **安全优化**：人类化操作模拟，降低被检测风险（v2.4 新增）

### 异常示例

```python
Exception: 点击 Traffic 标签失败，已重试 3 次
```

## 注意事项

1. **浏览器连接**：确保紫鸟浏览器已启动并开启 CDP 端口
2. **网络稳定**：建议在网络稳定的环境下运行
3. **文件路径**：确保 `DOWNLOAD_PATHS` 中配置的路径存在且有写入权限
4. **历史目录**：历史导入目录应位于各国家文件夹下的 `历史导入` 子目录
5. **运行时间**：根据日期范围大小，完整流程可能需要较长时间

## 技术栈

- **Python 3.x**
- **Playwright**: 浏览器自动化
- **CDP (Chrome DevTools Protocol)**: 浏览器连接

## 安全优化说明

### 人类化操作模拟

为避免被TEMU识别为自动化脚本，本工具实施了以下安全措施：

1. **点击操作优化**
   - 所有点击操作前先执行hover（鼠标悬停）
   - 点击延迟使用随机值（50-150ms），模拟人类点击速度
   - 点击后随机等待（0.8-2.5秒），模拟操作反应时间

2. **随机延迟优化**
   - 所有固定延迟改为随机延迟
   - 操作间隔使用随机范围，避免固定模式
   - 根据操作类型使用不同的延迟范围

3. **操作流程优化**
   - 使用Playwright标准API，避免直接DOM操作
   - 验证页面状态后再继续操作
   - 等待页面完全加载（DOM + 网络空闲）后再执行操作

### 已优化的操作

- ✅ Analytics 菜单点击
- ✅ Product analytics 按钮点击
- ✅ Sales 标签点击
- ✅ Today 按钮点击
- ✅ 日期选择器点击（图标和输入框）
- ✅ 日期选择器左箭头点击
- ✅ 日期单元格点击
- ✅ Apply 按钮点击
- ✅ Download 按钮点击
- ✅ 国家选择器点击
- ✅ 国家选项点击

## 更新日志

### v2.4 (2025-01-XX)
- 全面安全优化：参考活动报名工具的安全措施
- 所有点击操作添加hover和随机延迟
- 将所有固定延迟改为随机延迟
- 优化操作间隔，模拟真实用户行为
- 降低被TEMU识别为自动化脚本的风险

### v2.3 (2025-01-XX)
- 修复Sales页面日期选择器strict mode violation错误
- 使用 `beast-core-datePicker-input` 容器精确定位Sales页面日期选择器
- 优化Sales页面日期选择器点击逻辑（先图标后输入框）
- 统一Sales和Traffic页面的日期选择器header定位方式

### v2.2 (2025-01-XX)
- 修复日期选择器左箭头按钮定位问题（strict mode violation）
- 增加下载失败重试机制（3次完整流程重试）
- 优化下载超时时间（30秒 → 60秒）
- 优化 Apply 按钮后等待机制（固定1.5秒 + 等待Download按钮）
- 优化 Product analytics 点击逻辑（无论是否存在都点击）
- 增加国家选择器点击后等待时间

### v2.1 (2025-01-XX)
- 添加重试机制（3次重试）
- 优化页面加载等待
- 移除跳过逻辑，失败后中止
- 支持多国家循环处理

### v2.0 (2025-01-XX)
- 重新使用识别按钮逻辑重写一遍
- 基础功能实现
- 单国家数据下载
- 日期范围自动计算

### v1.0 (历史版本)
- 基础功能实现
- 单国家数据下载
- 日期范围自动计算

## 联系方式

如有问题或建议，请联系开发团队。

