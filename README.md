# 数据分析系统使用说明

## 📋 项目简介

这是一个基于 Flask 的交互式数据分析系统，用于分析商品曝光、点击、动销等数据。系统提供七个核心功能模块，支持多表管理、数据可视化、状态分析和记录更新，并可对多国家表进行批量操作。

## 🎯 主要功能

1. **快速查找** - 根据商品ID快速查看曝光、动销趋势和相关性分析
2. **动销品管理** - 分析商品状态变更（上升期/非上升期），统计状态变化
3. **优化效果数据** - 查看Video和Price标记商品的优化效果
4. **手动更新记录** - 便捷更新Reason、Video、Price字段
5. **数据筛选** - 多条件筛选和排序数据
6. **指标计算** - 综合计算各项业务指标并生成可视化图表，支持缓存模式和非缓存模式，可查看goods_id列表
7. **批量国家运行**（v2.1）- 对多国家数据表批量执行刷新、快速刷新、自动更新Reason、保存指标数据，支持进度条与随时取消

## 📦 系统要求

- Python 3.7+
- MySQL 5.7+
- 现代浏览器（Chrome、Firefox、Edge等）

## 🚀 安装步骤

### 1. 克隆或下载项目

```bash
cd App_DataAnalysis
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

依赖包包括：
- Flask 2.3.3
- pymysql 1.1.0
- pandas 2.0.3
- numpy 1.24.3
- matplotlib 3.7.2
- scipy 1.11.2
- openpyxl 3.1.2

### 3. 配置数据库

系统需要连接两个数据库：
- **Vida_Traffic** - 存储流量数据（表名格式：ROA1_XX，如ROA1_NL）
- **Vida_Sales** - 存储销售数据（表名格式：ROA1_XX_Sales，如ROA1_NL_Sales）

### 4. 启动应用

```bash
python app.py
```

应用将在 `http://0.0.0.0:5000` 启动，在浏览器中访问 `http://localhost:5000` 即可使用。

## ⚙️ 配置说明

### 数据库配置

1. 点击页面右上角的"配置"按钮
2. 在弹出的配置窗口中设置：

**Traffic数据库配置：**
- Host: 数据库主机地址（默认：127.0.0.1）
- Port: 端口号（默认：3306）
- Database: 数据库名称（默认：Vida_Traffic）
- User: 用户名（默认：root）
- Password: 密码
- 当前表名：根据选择的表自动显示

**Sales数据库配置：**
- Host: 数据库主机地址（默认：127.0.0.1）
- Port: 端口号（默认：3306）
- Database: 数据库名称（默认：Vida_Sales）
- User: 用户名（默认：root）
- Password: 密码
- 当前表名：自动添加_Sales后缀

3. 点击"保存"按钮保存配置

### 表选择

在页面顶部输入表名（如：ROA1_NL），点击"确认"按钮切换当前操作的表。

**注意：** 系统会自动在Sales数据库中查找对应的表（表名后加_Sales），例如选择ROA1_NL，会自动查找ROA1_NL_Sales。

## 📖 功能使用指南

### 功能1：快速查找

**用途：** 快速查看指定商品的曝光、动销趋势和点击相关性

**操作步骤：**
1. 点击"快速查找"按钮
2. 输入要查询的 `goods_id`
3. 点击"查找"按钮

**显示内容：**
- **双轴趋势图**：显示曝光量（折线图）和动销人数（条形图）的时间趋势
- **散点图**：显示曝光量与点击量的相关性，包含3% CTR参考线
- **数据摘要**：
  - 日期范围
  - 总曝光量、平均曝光量、最大曝光量
  - 总动销人数、有动销的天数
  - 相关系数

### 功能2：动销品管理

**用途：** 分析商品状态变更，统计上升期和非上升期的商品

**重要说明：**
- 系统默认统计**昨天的数据**（因为只能获取前一天的完整数据）
- 可以手动修改日期查看历史数据
- **自动更新功能**：如果目标日期没有Status数据，系统会自动分析并更新Status字段
- **结果缓存**：分析结果会自动缓存，切换功能后返回仍可查看（图片需重新分析获取）

**操作步骤：**
1. 点击"动销品管理"按钮
2. 确认或修改目标日期（默认昨天）
3. 点击"分析"按钮
4. 如果目标日期没有Status数据，系统会自动更新后再分析

**刷新功能：**
- **刷新数据**：刷新所有有动销的商品从首次动销日期到昨天的所有Status数据（完整刷新）
- **快速刷新**：只更新所有动销品在昨天的Status数据，速度更快，适合日常快速更新

**显示内容：**

**统计信息：**

```text
日期：2025-01-15
前一天上升期：30个
计算上升期：32个
实际上升期：32个
非上升期：161个
新增上升期：5个
新增非上升期：10个
更新为上升期：3个
由非上升期重回上升期：2个
！！！由上升期到非上升期：1个
```

**上升期说明：**
- **前一天上升期**：前一天的实际上升期数量
- **计算上升期**：根据前一天上升期数量和各类变更数量计算得出的理论上升期数量
  - 计算公式：前一天上升期 + 新增上升期 + 更新为上升期 + 由非上升期重回上升期 - 由上升期到非上升期
- **实际上升期**：选定日期Status=1的数量（数据库实际状态）
- 通过对比计算上升期和实际上升期，可以验证数据一致性

**状态说明：**
- **上升期（Status=1）**：商品曝光趋势上升
- **非上升期（Status=2）**：商品曝光趋势下降或平稳
- **新增上升期**：选定日期Status=1，前一天没有Status数据，历史没有Status数据（首次出现且为上升期）
- **新增非上升期**：选定日期Status=2，前一天没有Status数据，选定日期前一直没有数据（首次出现且为非上升期）
- **更新为上升期**：选定日期Status=1，前一天没有Status数据，但历史有Status数据，最近历史状态为1（之前是上升期，中间缺货后恢复）
- **由非上升期重回上升期**：前一天Status=2且选定日期Status=1，或前一天没有Status数据但历史最近一次Status=2（简化判断，不检查上升趋势）
- **由上升期到非上升期**：⚠️ 需要特别注意，前一天Status=1，选定日期Status=2，表示商品从上升期转为非上升期

**状态判断逻辑流程图：**

```text
选定日期 Status = 1?
├─ 是 → 前一天有数据?
│   ├─ 是 → 前一天 Status = 1? → 不记录（保持上升期）
│   │   └─ 前一天 Status = 2? → 【由非上升期重回上升期】
│   └─ 否 → 历史有Status数据?
│       ├─ 否 → 【新增上升期】
│       └─ 是 → 最近历史Status = 2? → 【由非上升期重回上升期】
│           └─ 最近历史Status = 1? → 【更新为上升期】
└─ 否（Status = 2）→ 前一天有数据?
    ├─ 是 → 前一天 Status = 1? → 【由上升期到非上升期】
    │   └─ 前一天 Status = 2? → 不记录（保持非上升期）
    └─ 否 → 历史有数据?
        ├─ 否 → 【新增非上升期】
        └─ 是 → 不记录（可能是缺货）
```

**图表显示：**
- **图片渲染模式**：可以选择性地生成特定类别的图片
  - 支持7个选项：上升期、非上升期、新增上升期、新增非上升期、更新为上升期、由非上升期重回上升期、由上升期到非上升期
  - 所有模块都会显示数据（文字信息），无论是否勾选
  - 只有勾选的模块才会生成图片，节省生成时间
  - 每个模块标题前显示 ▶ 图标，标题以加粗形式显示，例如：**▶ 新增上升期：2个**
- 商品图表（每行3个商品）：根据图片渲染模式选择生成
- **商品信息文字**：在每张图表上方显示商品信息（goods_id、加入时间、Reason），方便CTRL+F搜索
- 基本信息统计：总记录数、商品数量、时间周期

**过滤模式：**
- **不过滤**：显示所有动销品（Buyers > 0）
- **启用过滤**：可以设置下限（最小值）和上限（最大值）来过滤商品
  - **下限**：所有历史日期的Buyers总和 >= 此值的商品
  - **上限**：所有历史日期的Buyers总和 <= 此值的商品（留空表示不限制上限）
  - **示例**：下限=1，上限=10，表示只显示Buyers总和在1到10之间的商品

**缓存功能：**
- 分析结果自动缓存到sessionStorage
- 切换功能后返回，仍可查看之前的分析结果（文本信息）
- 图片数据不缓存（避免存储配额超限）
- 点击"清除缓存"按钮可手动清除

**历史记录：**
- 每次分析后自动保存到`History_Dynamic`目录
- 文件名格式：`日期_表名.txt`
- 保存规则：
  - 有新增商品时：自动覆盖文件
  - 无新增商品且文件已存在：跳过保存
- 文件内容包含：
  - 统计信息（包括前一天上升期、计算上升期、实际上升期）
  - 各分类的具体goods_id列表（新增上升期、新增非上升期、更新为上升期、由非上升期重回上升期、由上升期到非上升期）
  - 计算上升期和实际上升期的差值goods_id（在计算上升期中但不在实际上升期中的，以及在实际上升期中但不在计算上升期中的）
  - 上升期和非上升期商品的详细信息

### 功能3：优化效果数据

**用途：** 查看标记了Video或Price的商品优化效果

**操作步骤：**
1. 点击"优化效果数据"按钮
2. 选择要查看的类型：
   - **Video标记**：查看标记了Video=1的商品
   - **Price标记**：查看标记了Price=1的商品
3. 系统自动显示结果

**显示内容：**
- **基本信息统计**：总记录数、商品数量、时间范围
- **商品图表**（每行3个商品）：
  - 商品曝光与动销双轴图
  - **红点标记**：在折线图上用红色圆点标记Video或Price标记的日期，方便识别优化时间点
- **商品信息文字**：在每张图表上方显示商品信息（goods_id、标记日期），方便CTRL+F搜索

### 功能4：手动更新记录

**用途：** 手动更新商品的Reason、Video、Price字段

**操作步骤：**

**更新Reason：**
1. 输入 `goods_id`
2. 选择或输入 `date_label`（默认昨天，可点击"使用昨天"按钮）
3. 输入 `Reason` 内容
4. 点击"更新"按钮

**更新Video/Price：**
1. 输入 `goods_id`
2. 选择或输入 `date_label`（默认昨天）
3. 点击"更新Video"或"更新Price"按钮

**便捷功能：**
- 输入goods_id后，系统自动加载该商品可用的日期列表
- 可以从下拉列表中选择日期
- 可以点击"使用昨天"按钮快速设置日期

### 功能5：数据筛选

**用途：** 对Traffic表进行多条件筛选和排序，并支持导出数据

**操作步骤：**
1. 点击"数据筛选"按钮
2. 设置筛选条件：
   - **日期范围**：日期从/到
   - **曝光量范围**：最小值/最大值
   - **点击量范围**：最小值/最大值
   - **CTR范围**：最小值/最大值
3. 选择排序字段和排序方式（递增/递减）
4. （可选）勾选**均值模式**：按goods_id分组计算均值，每个goods_id只显示一条记录
5. （可选）勾选**上架时间筛选模式**：按商品上架日期（第一次出现的date_label）筛选
6. 点击"筛选"按钮查看结果
7. 点击"导出数据"按钮导出筛选结果

**筛选模式说明：**

**均值模式：**
- 勾选后，在选定时间段内，对每个goods_id的所有数据取均值
- 输出结果中goods_id不重复，每个goods_id只显示一条记录（均值）
- 数值字段（曝光量、点击量、CTR等）计算均值，保留2位小数
- 日期字段显示日期范围（如"2025-01-01 至 2025-01-31"）
- Video/Price字段：如果时间段内任何一个为1，则显示1；如果所有值都是空值，显示None；否则显示0
- 可以按均值字段进行排序

**上架时间筛选模式：**
- 勾选后，时间范围筛选的是每个goods_id在traffic表中第一次出现的date_label（上架日期）
- 如果某个goods_id的上架日期在筛选的时间范围内，就输出该goods_id从其上架日期到最新时间的所有数据
- 适用于查找在特定时间段内上架的商品

**模式叠加：**
- 均值模式和上架时间筛选模式可以同时使用
- 叠加后：先按上架时间筛选，再计算均值
- 结果标题会显示当前启用的模式组合

**筛选结果：**
- 以表格形式显示筛选后的数据
- 显示总记录数和当前模式标识
- 支持分页显示（每页100条）

**导出功能：**
- 支持导出为 **CSV** 或 **Excel** 格式
- 导出全部筛选结果（不分页）
- 保持筛选条件和排序设置
- 文件名自动包含表名、时间戳和模式标识
  - 格式：`筛选数据[模式标识]_表名_时间戳.csv/xlsx`
  - 模式标识：`_均值`、`_上架筛选`、`_均值_上架筛选`
- CSV文件使用UTF-8-sig编码，确保Excel正确显示中文
- Excel工作表名称会显示相应的模式标识
- 文件自动下载到本地

### 功能6：指标计算

**用途：** 综合计算各项业务指标并生成可视化图表

**前置条件：**
- 需要先配置数据目录（未核价数据目录和限流数据目录）
- 数据目录中应包含各个站点名称的子目录（如ROA1_FR），每个站点目录下包含未核价数据和限流数据的xlsx文件

**操作步骤：**
1. 点击"指标计算"按钮
2. （首次使用）点击"配置数据目录"按钮，配置未核价数据目录和限流数据目录
3. 选择查询日期（默认昨天，可修改）
4. （可选）勾选"非缓存模式"复选框
   - **未勾选**：优先使用缓存，如果缓存存在则直接返回结果（不生成图表），速度很快
   - **勾选**：重新计算所有指标并生成图表，覆盖原有缓存
5. 点击"计算指标"按钮

**显示内容：**

**指标卡片：**
- **指标1：非限流在售商品数量** - 在售商品中排除未核价和限流后的数量
- **指标2：二次限流占比** - 限流商品在总在售商品中的占比
- **指标3：历史动销品数量** - 历史上所有有过销量的商品数量
- **指标4：在售动销品数量** - 在售且有过销量的商品数量，可查看goods_id列表
- **指标5：二次限流动销品占比** - 二次限流动销品在相关商品中的占比，可查看二次限流动销品goods_id列表
- **指标6：日均单量（近7日）** - 近7天的平均日订单量
- **指标7：过程数据展示** - 显示无风险active、有风险active、限流数据、未核价数据、历史动销被限流等详细数据

**图表显示：**
- **近30天GMV图**：双轴图，柱状图显示销售额，折线图显示销量
- **日均GMV图（近7日）**：双轴图，柱状图显示销售额，折线图显示销量
- 缓存模式下不生成图表，显示提示信息

**保存功能：**
- 点击"保存指标数据"按钮，将当前指标数据保存到 `指标体系数据.xlsx` 文件
- 每个sheet对应一个国家站点（表名）
- 每次保存会追加新行，不覆盖已有数据
- K列（本周在售动销品数）= 在售动销品数量 + 二次限流动销品数量
- D、E、L、M列（增长率、占比列）自动格式化为百分位，保留两位小数

**缓存机制：**
- 缓存保存在 `Cache_Indicator` 目录，格式为 JSON
- 缓存文件命名：`{站点名}_{日期}.json`（如：`FR_2026-01-25.json`）
- 缓存不包含图表数据（base64图片太大）
- 缓存包含所有指标数值和goods_id列表
- 非缓存模式会重新计算并覆盖原有缓存

**计算公式说明：**
- **二次限流动销品占比** = 历史动销被限流数量 ÷ (在售动销品数量 + 历史动销被限流数量) × 100%
- 反映二次限流动销品在相关商品中的占比

### 功能7：批量国家站点运行（v2.1）

**用途：** 对多个国家数据表同时执行刷新、快速刷新、自动更新Reason、保存指标数据等操作，不依赖当前选择的单表，支持进度条与随时取消。

**前置条件：**
- 需先添加国家数据表名称（如 `ROA1_CZ`、`ROA1_DE`）到「已配置的国家表」列表
- 勾选要参与批量的国家表
- 运行时会在四个数据库中校验表是否存在：Traffic、Sales、货盘、平台商品表（表名后缀为国家代称，如 CZ）

**操作步骤：**
1. 点击「批量国家运行」进入功能7
2. **添加国家表**：在「添加国家数据表」框输入表名（如 `ROA1_CZ`），点击「添加」
3. **选择国家表**：在「已配置的国家表」中勾选本次要批量处理的国家表（支持全选/取消全选）
4. （可选）点击「验证所选表」检查所选表在四个库中是否都存在
5. （可选）选择「目标日期」，默认昨天；批量保存指标时使用此日期
6. 在「批量操作」区域点击对应按钮：
   - **批量刷新**（功能2）：对所有选中国家执行完整刷新 Status
   - **批量快速刷新**（功能2）：对所有选中国家执行仅昨天的快速刷新
   - **批量更新Reason**（功能4）：对所有选中国家执行自动更新 Reason（要求限流数据目录中存在对应国家子目录，否则该国会报错/跳过）
   - **批量保存指标**（功能6）：对所有选中国家先计算指标到缓存，再保存到「指标体系数据.xlsx」对应 sheet（要求数据目录中存在对应国家子目录，否则该国会报错/跳过）

**进度与取消：**
- 执行任一批量操作时会弹出进度窗口，显示「已完成 x / 总数」和当前表名
- 点击「取消」可随时中止：会立即终止当前请求（AbortController），并停止后续表的请求，已完成的表会汇总展示，并标记为「已取消」

**界面说明：**
- 「添加国家数据表」与「已配置的国家表」两框左右上下对齐、等高
- 已配置的国家表以网格小格展示，避免国家多时与左侧框高度差过大
- 批量操作区域标题为「批量操作」、文字为黑色，区域背景为白色

### 批量标记功能

**用途：** 批量标记商品的Reason字段（缺货或二次限价）

**功能说明：**
- 位于`Batch_marking`目录下，包含两个子目录：
  - `Out_of_stock`：缺货标记
  - `Secondary_traffic_restricted`：二次限价标记

**操作步骤：**

**缺货标记（Out_of_stock）：**
1. 从数据库导出缺货商品数据：
   ```sql
   SELECT *
   FROM `ROA1_XX`
   WHERE detail_status = 'Out of stock';
   ```
   - 注意：格式选择CSV文件
2. 将CSV文件放入对应国家的目录（如`Batch_marking/Out_of_stock/ROA1_NL/`）
3. 运行对应国家的`add.py`脚本，或运行`batch_run.py`批量处理所有国家
4. 系统会自动：
   - 读取CSV文件中的goods_id
   - 匹配数据库中Status不为空的goods_id
   - 更新匹配商品的Reason字段为"Out_of_stock"
   - 如果昨天没有数据，自动标记到最近的有数据的日期

**二次限价标记（Secondary_traffic_restricted）：**
1. 从Temu后台pricing health直接导出Excel文件
2. 将Excel文件放入对应国家的目录（如`Batch_marking/Secondary_traffic_restricted/ROA1_NL/`）
3. 运行对应国家的`add.py`脚本，或运行`batch_run.py`批量处理所有国家
4. 系统会自动：
   - 读取Excel文件中的goods_id（从"Goods ID"列）
   - 匹配数据库中Status不为空的goods_id
   - 更新匹配商品的Reason字段为"Secondary_traffic_restricted"
   - 如果昨天没有数据，自动标记到最近的有数据的日期

**注意事项：**
- ⚠️ **每次导入前要清空对应国家目录中的旧文件**
- 📝 **手动Reason字段只能填写以下值**：
  - `OK(Out_of_stock)`
  - `OK(Secondary_traffic_restricted)`
  - `Out_of_stock`
  - `Secondary_traffic_restricted`
- 📂 **历史记录**：每次标记操作会自动保存历史记录到对应目录的"历史记录"文件夹
- 🌍 **支持的国家**：AT、BE、CZ、DE、FR、IT、NL、PL、RO

## 🔧 技术架构

### 后端结构

```plaintext
app.py                    # Flask主应用，路由和API
config.py                 # 配置管理模块
db_utils.py               # 数据库工具函数
function1_quick_search.py      # 功能1：快速查找
function2_dynamic_management.py # 功能2：动销品管理
function3_optimization.py       # 功能3：优化效果数据
function4_manual_update.py      # 功能4：手动更新记录
function5_data_filter.py        # 功能5：数据筛选
function6_indicator_calculation.py # 功能6：指标计算
function7_batch_operations.py   # 功能7：批量国家站点运行（v2.1）
plot_utils.py             # 图表绘制工具
```

### 前端结构

```plaintext
templates/
  └── index.html          # 主页面模板
static/
  ├── css/
  │   └── style.css       # 样式文件
  └── js/
      └── main.js         # 前端交互逻辑
```

## 📊 数据库表结构

### Traffic表（如：ROA1_NL）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| goods_id | INT | 商品ID |
| date_label | DATE | 日期标签 |
| Product impressions | DECIMAL | 产品曝光量 |
| Number of visitor impressions of the product | DECIMAL | 访客产品曝光数 |
| Product clicks | DECIMAL | 产品点击量 |
| Number of visitor clicks on the product | DECIMAL | 访客产品点击数 |
| CTR | DECIMAL | 点击率 |
| Status | INT | 状态（1=上升期，2=非上升期） |
| Reason | TEXT | 原因说明 |
| Video | INT | 视频标记（1=已标记） |
| Price | INT | 价格标记（1=已标记） |

### Sales表（如：ROA1_NL_Sales）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| goods_id | INT | 商品ID |
| date_label | DATE | 日期标签 |
| Buyers | INT | 购买人数（动销） |

## 🔍 API接口说明

### 配置相关

- `GET /api/config` - 获取配置
- `POST /api/config` - 更新配置

### 表管理

- `GET /api/table` - 获取当前表
- `POST /api/table` - 设置当前表
- `GET /api/tables` - 获取可用表列表

### 功能API

- `POST /api/function1/quick_search` - 快速查找
- `POST /api/function2/dynamic_management` - 动销品管理
- `POST /api/function2/refresh_status` - 刷新Status数据（完整刷新）
- `POST /api/function2/quick_refresh_status` - 快速刷新Status数据（仅昨天，刷新所有动销品）
- `POST /api/function3/optimization` - 优化效果数据
- `POST /api/function4/update_reason` - 更新Reason
- `POST /api/function4/update_video` - 更新Video
- `POST /api/function4/update_price` - 更新Price
- `GET /api/function4/available_dates` - 获取可用日期列表
- `POST /api/function5/filter` - 数据筛选（支持均值模式和上架时间筛选模式）
- `POST /api/function5/export` - 导出筛选数据（支持CSV和Excel格式，支持均值模式和上架时间筛选模式）
- `GET /api/function6/config` - 获取指标计算配置
- `POST /api/function6/config` - 更新指标计算配置（未核价数据目录和限流数据目录）
- `POST /api/function6/indicators` - 计算所有指标（支持use_cache参数，控制是否使用缓存）
- `POST /api/function6/save` - 保存指标数据到Excel文件

### 功能7：批量国家运行（v2.1）

- `GET /api/function7/config` - 获取批量国家配置（可用表、已选表）
- `POST /api/function7/config` - 更新已选中的国家表
- `POST /api/function7/add_table` - 添加国家数据表到可选列表
- `POST /api/function7/remove_table` - 从可选列表移除国家数据表
- `POST /api/function7/validate_table` - 校验单个国家表在四库中是否存在
- `POST /api/function7/validate_all` - 校验所有已选国家表
- `POST /api/function7/single_refresh` - 单表刷新 Status（供进度条逐表调用）
- `POST /api/function7/single_quick_refresh` - 单表快速刷新 Status
- `POST /api/function7/single_auto_reason` - 单表自动更新 Reason
- `POST /api/function7/single_save_indicator` - 单表计算并保存指标数据
- `POST /api/function7/batch_refresh` - 批量刷新（后端一次性，可选）
- `POST /api/function7/batch_quick_refresh` - 批量快速刷新（可选）
- `POST /api/function7/batch_auto_reason` - 批量更新 Reason（可选）
- `POST /api/function7/batch_save_indicator` - 批量保存指标（可选）

## ⚠️ 注意事项

1. **日期默认值**：系统默认使用**昨天的日期**进行统计，因为只能获取前一天的完整数据
2. **表名规则**：Traffic表名格式为 `ROA1_XX`，Sales表名自动添加 `_Sales` 后缀
3. **数据更新**：更新操作会立即生效，请谨慎操作
4. **状态变更**：由上升期到非上升期的商品会特别标记（!!!），需要重点关注
5. **图表显示**：图表以base64编码的图片形式返回，支持在浏览器中直接查看

## 🐛 常见问题

### Q1: 无法连接数据库
**A:** 检查数据库配置是否正确，确保数据库服务已启动，网络连接正常。

### Q2: 找不到表
**A:** 确认表名输入正确，表名格式应为 `ROA1_XX`（XX为国家代码，如NL、IT等）。

### Q3: 图表不显示
**A:** 检查是否有数据，确认goods_id是否正确，查看浏览器控制台是否有错误信息。

### Q4: 日期选择问题
**A:** 系统默认使用昨天，如需查看其他日期，请手动修改日期输入框。

### Q5: 状态统计不准确
**A:** 确保数据库中的Status字段已正确更新，检查目标日期是否有数据。

## 📝 更新日志

### v2.11.0 (2025-01-26)
- ✨ **功能6增强**：指标计算功能全面优化
  - 🔄 **非缓存模式**：新增"非缓存模式"复选框
    - 未勾选（默认）：优先使用缓存，如果第一次在某个日期运行会形成缓存，下次运行相同国家站点和时间直接调取缓存数据，不画图，加快速度
    - 勾选：按原来一样重新计算和画图，并覆盖原有缓存
    - 缓存模式下不生成图表（GMV图），大幅提升速度
    - 缓存保存在 `Cache_Indicator` 目录，格式为 JSON
  - 📊 **指标显示增强**：
    - "二次限流动销品占比"指标现在可以查看二次限流动销品goods_id列表（类似"在售动销品数量"）
    - 点击"查看二次限流动销品goods_id"按钮可展开查看完整的goods_id列表
  - 📈 **计算公式优化**：
    - "二次限流动销品占比"计算公式更新为：`历史动销被限流数量 ÷ (在售动销品数量 + 历史动销被限流数量) × 100%`
    - 更准确地反映二次限流动销品在相关商品中的占比
  - 💾 **Excel保存优化**：
    - K列（本周在售动销品数）计算方式更新：`在售动销品数量 + 二次限流动销品数量`
    - D、E、L、M列（增长率、占比列）在所有sheet中强制使用百分位格式，保留两位小数（`0.00%`）
    - 确保所有历史数据和新数据都统一使用百分位格式显示

### v2.1.0 (2025-01-26)
- ✨ **新增功能7：批量国家站点运行**
  - 🌍 **国家表管理**：
    - 支持手动添加国家数据表名称（如 ROA1_CZ）到可选列表，勾选后作为批量目标
    - 列表为空时需先添加，表名作为后续批量切换的目标
  - ✅ **表存在性校验**：
    - 在 Traffic、Sales、货盘、平台商品表四个库中校验所选表是否存在（后缀为国家代称如 CZ）
    - 支持「验证所选表」一键检查所有已选表
  - 🔄 **批量操作**（针对所有已选国家表，不依赖当前单表）：
    - **批量刷新**：功能2的「刷新」— 对每个国家执行完整 Status 刷新
    - **批量快速刷新**：功能2的「快速刷新」— 对每个国家仅刷新昨天 Status
    - **批量更新Reason**：功能4的「自动更新Reason」— 执行前检查限流数据目录中是否有该国子目录，无则报错/跳过
    - **批量保存指标**：功能6的「保存指标数据」— 先计算指标到缓存再写入对应 xlsx；执行前检查数据目录中是否有该国子目录，无则报错/跳过
  - 📊 **进度条与取消**：
    - 每个批量操作均采用串行单表请求，弹出进度窗口，显示「已完成 x / 总数」与当前表名
    - 支持随时点击「取消」：通过 AbortController 立即中止当前请求并停止后续表，已完成的表会汇总显示并标记「已取消」
  - 🎨 **界面**：
    - 「添加国家数据表」与「已配置的国家表」两框左右上下对齐、等高
    - 已配置国家表以网格小格展示，减少国家多时与左侧框高度差
    - 批量操作区域标题为「批量操作」、文字黑色、区域背景白色
  - 🔌 **后端**：
    - 新增单表 API：`/api/function7/single_refresh`、`single_quick_refresh`、`single_auto_reason`、`single_save_indicator`，供前端逐表调用以实现进度与取消

### v2.0.0 (2025-01-20)
- 🐛 **关键修复**：修复功能4更新状态时的"too many values to unpack"错误
  - 🔧 **问题原因**：`db_utils.py`中多个函数错误地将`get_db_config()`解包为2个值，而该函数实际返回4个值
  - 🔄 **修复内容**：修复了6个函数中的解包问题：
    - `get_filtered_data()` - 第238行
    - `check_date_exists()` - 第395行
    - `update_reason()` - 第415行
    - `update_video()` - 第435行
    - `update_price()` - 第455行
    - `get_latest_date_label()` - 第475行
  - ✅ **修复结果**：所有解包现在都正确使用4个值：`traffic_config, _, _, _ = get_db_config()`
  - 🎯 **影响**：功能4的所有更新操作（Reason、Video、Price）现在都可以正常工作

### v1.9.0 (2025-01-15)
- ✨ **功能2重构**：半图片模式全面升级
  - 🗑️ **去除图片模式**：移除独立的"图片模式"选项，简化界面
  - 🎯 **图片渲染模式扩展**：图片渲染模式现在支持7个选项
    - 新增"非上升期"选项：可以单独生成所有非上升期商品的图片
    - 完整选项列表：上升期、非上升期、新增上升期、新增非上升期、更新为上升期、由非上升期重回上升期、由上升期到非上升期
  - 📊 **数据展示优化**：
    - 所有模块都会显示数据（文字信息），无论是否勾选
    - 只有勾选的模块才会生成图片，节省生成时间
    - 每个模块显示格式：`▶ 模块名称：X个`，后跟商品详细信息列表
  - 🎨 **UI优化**：
    - 所有模块标题前添加 ▶ 图标
    - 所有模块标题以加粗形式显示，提升可读性
    - 更新功能说明，详细说明图片渲染模式的7个选项和使用方式
  - 🔧 **后端优化**：
    - 重构`dynamic_management`函数，去除`generate_images`参数
    - 优化数据返回结构，新增`categories`字段包含各类别的数据和图片
    - 确保所有类别数据都被正确获取和返回，即使未勾选图片生成
  - 📝 **文档更新**：
    - 更新功能说明中的选项说明部分
    - 移除图片模式相关说明
    - 更新图片渲染模式说明，包含7个选项的详细描述
- 🔍 **过滤模式增强**：过滤模式全面升级，支持灵活的下限和上限设置
  - 🎛️ **UI重新设计**：将下拉选择框改为复选框+输入框组合
    - 添加"启用过滤"复选框，控制过滤功能的开关
    - 新增"下限（最小值）"输入框：设置Buyers总和的最小值
    - 新增"上限（最大值）"输入框：设置Buyers总和的最大值（可选，留空表示不限制）
  - 🧮 **过滤逻辑升级**：支持更灵活的范围过滤
    - **下限过滤**：所有历史日期的Buyers总和 >= 指定值
    - **上限过滤**：所有历史日期的Buyers总和 <= 指定值
    - **范围过滤**：同时设置下限和上限，实现精确的Buyers总和范围筛选
    - **示例**：下限=1，上限=10，表示只显示Buyers总和在1到10之间的商品
  - 🔧 **后端优化**：
    - 新增`build_filter_condition()`辅助函数，构建SQL过滤条件
    - 更新所有数据获取函数，支持新的字典格式过滤模式
    - 优化查询性能，确保过滤条件在SQL层面高效执行
  - 📚 **功能说明更新**：更新文档中的过滤模式使用说明

### v1.8.0 (2025-01-15)
- ✨ **功能2增强**：动销品管理功能全面优化
  - 📊 **计算上升期和实际上升期对比**：
    - 新增"计算上升期"统计：根据前一天上升期数量和各类变更数量计算得出的理论上升期数量
    - 新增"实际上升期"统计：选定日期Status=1的数量（数据库实际状态）
    - 计算公式：计算上升期 = 前一天上升期数量 + 新增上升期 + 更新为上升期 + 由非上升期重回上升期 - 由上升期到非上升期
    - 通过对比计算上升期和实际上升期，可以验证数据一致性
    - 前一天上升期是指前一天的实际上升期
  - 🔧 **判断逻辑优化**：
    - 修复"新增上升期"判断：现在正确检查历史是否有Status数据（不仅仅是Traffic数据），如果历史没有Status数据，判断为新增上升期
    - 修复"更新为上升期"判断：之前是上升期，中间可能缺货，现在恢复为上升期的情况
    - 简化"由非上升期重回上升期"判断：只要前一天是2、选定日期是1，就是"由非上升期重回上升期"，不再检查上升趋势
  - 📝 **历史记录增强**：
    - 在txt文件中输出各分类的具体goods_id列表（新增上升期、新增非上升期、更新为上升期、由非上升期重回上升期、由上升期到非上升期）
    - 在txt文件中输出计算上升期和实际上升期的差值goods_id（在计算上升期中但不在实际上升期中的，以及在实际上升期中但不在计算上升期中的）
  - 🎨 **前端优化**：
    - 在统计信息中显示前一天上升期、计算上升期、实际上升期
    - 更新功能说明中的"新增上升期"和"更新为上升期"定义
    - 更新"由非上升期重回上升期"定义（简化判断说明）
    - 简化按钮说明文字，将详细说明移到页面底部的功能说明中
    - 修改"快速刷新（仅昨天）"按钮为"快速刷新"
    - 在功能说明中添加计算上升期和实际上升期的详细说明

### v1.7.0 (2025-01-15)
- ✨ **功能2增强**：动销品管理功能全面优化
  - 🔄 **非缓存模式**：新增"非缓存模式"复选框，选中后重新分析，不使用缓存数据，并覆盖原有缓存
  - 📅 **加入时间优化**：将"加入时间"改为"第一个动销的时间"（Vida_Sales表中Buyers > 0的最早日期），避免出现未来日期
  - 🚫 **数据过滤优化**：修复了显示未来才动销的商品的问题，现在只显示在选定日期或之前已经开始动销的商品
  - 📊 **统计准确性提升**：修复了上升期数量与变更统计不一致的问题，确保所有上升期商品都被正确统计到变更类型中
  - 📖 **功能说明**：在页面底部添加了详细的功能说明（可折叠），包括核心概念、按钮功能、分类准则和特殊说明
  - 🎨 **UI优化**：将特殊说明移到页面最底端，使用折叠形式显示，提升页面美观度
  - 🔍 **快速刷新优化**：快速刷新功能现在会刷新所有动销品在昨天的Status数据，而不仅仅是昨天有动销的商品

### v1.6.0 (2025-01-15)
- ✨ **功能2增强**：刷新数据时自动创建缺失列
  - 🔧 **自动创建列**：在刷新Status数据时，如果表中不存在Status、Reason、Video、Price列，系统会自动创建这些列
  - 🐛 **问题修复**：修复了刷新数据时查询语句不一致的问题，统一使用正确的数据库前缀
  - 🔄 **更新逻辑优化**：改进了Status更新逻辑，确保正确统计更新数量
  - 💡 **使用场景**：适用于新站点（如PL）首次使用功能2时，自动创建必需的列结构
- ✨ **新增功能**：批量标记Reason字段
  - 📦 **批量标记工具**：新增`Batch_marking`目录，支持批量标记商品的Reason字段
  - 🏷️ **缺货标记（Out_of_stock）**：
    - 从CSV文件读取goods_id列表（支持多个CSV文件）
    - 自动匹配数据库中Status不为空的goods_id
    - 批量更新匹配商品的Reason字段为"Out_of_stock"
    - 如果目标日期（昨天）没有数据，自动标记到最近的有数据的日期
    - 支持批量运行所有国家的标记脚本
  - 🚫 **二次限价标记（Secondary_traffic_restricted）**：
    - 从Excel文件读取goods_id列表（支持多个Excel文件）
    - 自动匹配数据库中Status不为空的goods_id
    - 批量更新匹配商品的Reason字段为"Secondary_traffic_restricted"
    - 如果目标日期（昨天）没有数据，自动标记到最近的有数据的日期
    - 支持批量运行所有国家的标记脚本
  - 📝 **历史记录**：每次标记操作自动保存历史记录到对应目录的"历史记录"文件夹
  - 🌍 **多国家支持**：支持AT、BE、CZ、DE、FR、IT、NL、PL、RO等多个国家
  - 💡 **使用说明**：
    - 缺货标记：从数据库导出`detail_status = 'Out of stock'`的数据为CSV格式
    - 二次限价标记：从Temu后台pricing health直接导出Excel文件
    - 手动Reason字段只能填写：`OK(Out_of_stock)`、`OK(Secondary_traffic_restricted)`、`Out_of_stock`、`Secondary_traffic_restricted`

### v1.5.0 (2025-01-15)
- ✨ **功能5增强**：数据筛选功能全面升级
  - 📊 **均值模式**：新增"均值模式"选项
    - 在选定时间段内，对每个goods_id的所有数据取均值
    - 输出结果中goods_id不重复，每个goods_id只显示一条记录
    - 数值字段计算均值，日期字段显示范围，Video/Price字段智能处理
    - 可以按均值字段进行排序，导出功能也支持均值模式
  - 📅 **上架时间筛选模式**：新增"上架时间筛选模式"选项
    - 按商品上架日期（第一次出现的date_label）进行筛选
    - 筛选出上架日期在时间范围内的goods_id
    - 输出这些goods_id从其上架日期到最新时间的所有数据
    - 适用于查找在特定时间段内上架的商品
  - 🔄 **模式叠加**：均值模式和上架时间筛选模式可以同时使用
    - 叠加后：先按上架时间筛选，再计算均值
    - 结果标题和导出文件名会显示当前启用的模式组合
  - 🐛 **问题修复**：修复Video和Price字段在均值模式下空值显示为0的问题
    - 现在空值正确显示为None，而不是0
    - Video和Price字段使用相同的处理逻辑，确保一致性

### v1.4.0 (2025-01-15)
- ✨ **功能3增强**：优化效果数据功能全面优化
  - 🎨 **图表增强**：在折线图上用红色圆点标记Video或Price标记的日期，直观显示优化时间点
  - 📋 **信息展示优化**：在图片上方显示商品信息和标记日期（类似功能2），方便查看和搜索
  - 📊 **布局优化**：调整显示顺序，基本信息统计显示在最上方
- ✨ **功能2增强**：新增快速刷新功能
  - ⚡ **快速刷新**：新增"快速刷新（仅昨天）"按钮，只更新昨天的Status数据，速度更快
  - 🔄 **完整刷新**：保留原有的"刷新数据"功能，刷新所有历史数据
  - 💡 **使用场景**：快速刷新适合日常快速更新，完整刷新适合定期全面更新

### v1.3.0 (2025-01-15)
- ✨ **功能2增强**：动销品管理功能全面优化
  - 🔄 **自动更新Status**：如果目标日期没有Status数据，系统会自动分析并更新Status字段
  - 💾 **结果缓存**：分析结果自动缓存，切换功能后返回仍可查看（不缓存图片数据，避免存储配额超限）
  - 📝 **历史记录**：每次分析后自动保存到`History_Dynamic`目录的txt文件
    - 文件名格式：`日期_表名.txt`
    - 有新增商品时自动覆盖，无新增时跳过保存
  - 🔍 **商品信息显示**：在图表上方显示商品信息文字（goods_id、加入时间、Reason），方便CTRL+F搜索
  - 🎯 **智能判断**：自动检测数据缺失并尝试修复
- 🐛 **问题修复**：修复sessionStorage存储配额超限问题（通过不缓存图片数据解决）

### v1.1.0 (2025-01-15)
- ✨ **新增功能**：数据筛选支持导出功能
  - 支持导出为CSV和Excel两种格式
  - 导出全部筛选结果（不分页）
  - 自动生成带时间戳的文件名
  - CSV文件使用UTF-8-sig编码，确保Excel正确显示中文
- 📦 **依赖更新**：添加openpyxl 3.1.2用于Excel导出
- 🔧 **功能优化**：优化导出流程，提升用户体验

### v1.0.0 (2025-01-15)
- 初始版本发布
- 实现五个核心功能模块
- 支持多表管理和配置
- 默认使用昨天的日期进行统计

## 👥 技术支持

如有问题或建议，请联系开发团队。

---

**当前版本：** v2.11.0

**最后更新：** 2025-01-26
