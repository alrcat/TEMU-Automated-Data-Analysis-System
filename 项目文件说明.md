# 项目文件说明文档

本文档详细说明数据分析系统中每个文件的作用和功能。

## 📁 项目结构概览

```
App_DataAnalysis/
├── app.py                          # Flask主应用
├── config.py                       # 配置管理模块
├── db_utils.py                     # 数据库工具函数
├── function1_quick_search.py       # 功能1：快速查找
├── function2_dynamic_management.py # 功能2：动销品管理
├── function3_optimization.py        # 功能3：优化效果数据
├── function4_manual_update.py      # 功能4：手动更新记录
├── function5_data_filter.py        # 功能5：数据筛选
├── plot_utils.py                   # 图表绘制工具
├── requirements.txt                # Python依赖包列表
├── app_config.json                 # 应用配置文件（自动生成）
├── README.md                       # 项目使用说明文档
├── templates/                      # HTML模板目录
│   └── index.html                  # 主页面模板
├── static/                         # 静态资源目录
│   ├── css/
│   │   └── style.css               # 样式文件
│   └── js/
│       └── main.js                 # 前端交互逻辑
├── History_Dynamic/                # 功能2历史记录目录
│   └── *.txt                       # 动销品管理分析历史记录
├── Cache_Dynamic/                  # 功能2缓存目录
│   └── *.json                      # 动销品管理分析缓存（JSON格式，不包含图片）
└── History_Version/                # 历史版本备份目录
    └── v1.x/                       # 各版本备份
```

---

## 📋 版本更新说明

### v2.0.0 (2025-01-20)
- 🐛 **关键修复**：修复功能4更新状态时的"too many values to unpack"错误
  - 🔧 **问题原因**：`db_utils.py`中多个函数错误地将`get_db_config()`解包为2个值，而该函数实际返回4个值
  - 🔄 **修复内容**：修复了6个函数中的解包问题：
    - `get_filtered_data()` - 第238行
    - `check_date_exists()` - 第395行
    - `update_reason()` - 第415行
    - `update_video()` - 第435行
    - `update_price()` - 第455行
    - `get_latest_date_label()` - 第475行
  - ✅ **修复结果**：所有解包现在都正确使用4个值：`traffic_config, _, _, _ = get_db_config()`
  - 🎯 **影响**：功能4的所有更新操作（Reason、Video、Price）现在都可以正常工作

---

## 🔧 核心文件说明

### 1. `app.py` - Flask主应用

**作用：** Flask Web应用的主入口文件，定义所有API路由和请求处理逻辑

**主要功能：**
- 初始化Flask应用和配置
- 定义所有API路由端点：
  - `/` - 主页面路由
  - `/api/config` - 配置管理API（GET/POST）
  - `/api/table` - 表管理API（GET/POST）
  - `/api/tables` - 获取可用表列表
  - `/api/function1/quick_search` - 功能1：快速查找
  - `/api/function2/dynamic_management` - 功能2：动销品管理（返回计算上升期和实际上升期统计）
  - `/api/function2/refresh_status` - 功能2：刷新Status数据（完整刷新）
  - `/api/function2/quick_refresh_status` - 功能2：快速刷新Status数据（刷新所有动销品在昨天的数据）
  - `/api/function2/export` - 功能2：导出数据
  - `/api/function3/optimization` - 功能3：优化效果数据
  - `/api/function4/update_reason` - 功能4：更新Reason
  - `/api/function4/update_video` - 功能4：更新Video
  - `/api/function4/update_price` - 功能4：更新Price
  - `/api/function4/available_dates` - 功能4：获取可用日期列表
  - `/api/function5/filter` - 功能5：数据筛选
  - `/api/function5/export` - 功能5：导出筛选数据
- 处理请求参数，调用相应的功能函数
- 返回JSON格式的响应数据
- 处理文件下载（导出功能）

**依赖：**
- Flask框架
- 所有功能模块（function1-5）
- config模块
- db_utils模块

---

### 2. `config.py` - 配置管理模块

**作用：** 管理系统配置，包括数据库连接配置和当前操作的表名

**主要功能：**
- **数据库配置管理：**
  - `load_config()` - 从JSON文件加载配置
  - `save_config(config)` - 保存配置到JSON文件
  - `get_default_config()` - 获取默认配置
  - `update_db_config(traffic_db, sales_db)` - 更新数据库配置
  - `get_db_config()` - 获取当前数据库配置

- **表管理：**
  - `get_current_table()` - 获取当前操作的表名
  - `set_current_table(table_name)` - 设置当前操作的表名

- **配置存储：**
  - 配置保存在 `app_config.json` 文件中
  - 包含Traffic数据库和Sales数据库的连接信息
  - 包含当前选择的表名

**默认配置：**
- Traffic数据库：Vida_Traffic
- Sales数据库：Vida_Sales
- 默认表名：ROA1_NL

---

### 3. `db_utils.py` - 数据库工具函数

**作用：** 提供所有数据库操作的通用工具函数

**主要功能：**

#### 数据库连接
- `get_db_connection(config)` - 获取数据库连接对象

#### 表管理
- `get_available_tables(cursor)` - 获取所有ROA1开头的表名列表

#### 日期工具
- `get_yesterday_date()` - 获取昨天的日期字符串（YYYY-MM-DD格式）

#### 数据查询函数
- `get_goods_data(table_name, sales_table_name, goods_id)` - 获取指定商品的所有数据
- `get_dynamic_goods_data(table_name, sales_table_name, status, target_date)` - 获取动销品数据（上升期或非上升期）
- `get_optimization_data(table_name, sales_table_name, field_name, target_date)` - 获取优化效果数据（Video=1或Price=1）
- `get_filtered_data(table_name, filters, sort_field, sort_order, on_shelf_filter_mode)` - 获取筛选后的数据（支持上架时间筛选模式）
- `get_declined_goods_data_with_discontinued(table_name, sales_table_name, target_date)` - 获取非上升期数据（包括下架缺货的商品）
- `get_goods_all_history_data(table_name, sales_table_name, status, target_date)` - 获取指定状态商品的所有历史数据
- `get_declined_from_rising_goods_data(table_name, sales_table_name, target_date)` - 获取由上升期到非上升期的商品数据

#### 数据更新函数
- `update_reason(table_name, goods_id, date_label, reason)` - 更新Reason字段
- `update_video(table_name, goods_id, date_label)` - 更新Video字段为1
- `update_price(table_name, goods_id, date_label)` - 更新Price字段为1

#### 数据检查函数
- `check_date_exists(table_name, goods_id, date_label)` - 检查指定goods_id和date_label是否存在
- `get_latest_date_label(table_name, goods_id)` - 获取指定goods_id最近的date_label
- `check_target_date_has_status_data(table_name, target_date)` - 检查目标日期是否有Status数据

**特点：**
- 统一的数据库连接管理
- 支持Traffic和Sales两个数据库
- 提供数据清洗和格式转换功能

---

### 4. `function1_quick_search.py` - 功能1：快速查找

**作用：** 实现快速查找功能，根据goods_id查询商品数据并生成可视化图表

**主要功能：**
- `quick_search(goods_id)` - 快速查找指定商品的数据
  - 从数据库获取商品的所有历史数据
  - 生成双轴趋势图（曝光量和动销人数）
  - 生成散点图（曝光量与点击量相关性）
  - 计算数据摘要（日期范围、曝光量统计、动销统计、相关系数）

**返回数据：**
- `trend_image` - 双轴趋势图（base64编码）
- `scatter_image` - 散点图（base64编码）
- `correlation` - 相关系数
- `summary` - 数据摘要

**依赖：**
- `db_utils.get_goods_data()` - 获取商品数据
- `plot_utils.plot_goods_trend_double_axis()` - 绘制双轴趋势图
- `plot_utils.plot_impressions_clicks_scatter()` - 绘制散点图

---

### 5. `function2_dynamic_management.py` - 功能2：动销品管理

**作用：** 实现动销品管理功能，分析商品状态变更（上升期/非上升期）

**主要功能：**

#### 核心功能函数
- `dynamic_management(target_date)` - 动销品管理主函数
  - 获取上升期和非上升期的商品数据
  - 生成统计信息（新增、更新、变更等）
  - 绘制商品图表
  - 保存历史记录

#### 状态分析函数
- `analyze_trend(impressions_series)` - 分析曝光趋势，判断是上升期还是非上升期
- `check_recent_rising_trend(impressions_series, days, threshold)` - 检查近期上升趋势是否明显
- `get_previous_day_status(cursor, table_name, sales_table_name, goods_id, target_date)` - 获取前一天的状态
- `auto_update_status_for_goods(cursor, table_name, sales_table_name, target_date, goods_ids)` - 为指定goods_id计算并更新status
- `auto_update_status_for_date(table_name, sales_table_name, target_date)` - 自动更新目标日期的Status数据

#### 数据刷新函数
- `refresh_status_data(table_name, sales_table_name)` - 刷新所有有动销的商品从首次动销日期到昨天的所有Status数据（完整刷新）
- `quick_refresh_status_data(table_name, sales_table_name)` - 快速刷新，刷新所有动销品在昨天的Status数据

#### 统计函数
- `get_status_statistics(table_name, sales_table_name, target_date)` - 获取状态统计信息（包含变更统计）
  - 计算前一天上升期数量
  - 计算计算上升期：前一天上升期 + 新增上升期 + 更新为上升期 + 由非上升期重回上升期 - 由上升期到非上升期
  - 获取实际上升期：选定日期Status=1的数量
  - 计算差值goods_id（在计算上升期中但不在实际上升期中的，以及在实际上升期中但不在计算上升期中的）
  - 记录各分类的goods_id列表（新增上升期、新增非上升期、更新为上升期、由非上升期重回上升期、由上升期到非上升期）
- `get_goods_info_with_status(df, table_name)` - 获取商品信息，包括加入时间和Reason
- `get_recent_history_status(cursor, table_name, goods_id, target_date)` - 获取goods_id在目标日期之前的最近一次历史状态
- `check_goods_has_any_data_before_date(cursor, table_name, goods_id, target_date)` - 检查goods_id在目标日期之前是否有任何数据

#### 历史记录函数
- `save_dynamic_management_history(target_date, stats, rising_info, declined_info, table_name)` - 保存动销品管理的历史记录到txt文件
  - 输出统计信息（包括前一天上升期、计算上升期、实际上升期）
  - 输出各分类的具体goods_id列表
  - 输出计算上升期和实际上升期的差值goods_id

#### 导出函数
- `export_dynamic_management_data(...)` - 导出动销品管理数据（支持多种格式和筛选条件）

**特点：**
- 自动更新Status字段
- 结果缓存功能
- 历史记录自动保存（包含各分类goods_id列表和差值goods_id）
- 支持完整刷新和快速刷新
- 计算上升期和实际上升期对比（用于验证数据一致性）
- 优化的判断逻辑：
  - 新增上升期：正确检查历史是否有Status数据
  - 更新为上升期：处理之前是上升期，中间缺货后恢复的情况
  - 由非上升期重回上升期：简化判断，只要前一天是2、选定日期是1即可（不检查上升趋势）

---

### 6. `function3_optimization.py` - 功能3：优化效果数据

**作用：** 实现优化效果数据功能，查看标记了Video或Price的商品优化效果

**主要功能：**
- `get_optimization_marked_dates(table_name, field_name)` - 获取标记了Video或Price的商品的标记日期
  - 返回格式：`{goods_id: [date1, date2, ...]}`
  - 自动处理日期类型转换（datetime.date → 字符串）

- `optimization_effect(field_name)` - 优化效果数据主函数
  - `field_name`: 'Video' 或 'Price'
  - 获取优化数据
  - 获取标记日期
  - 绘制图表（支持红点标记）
  - 生成商品信息和统计摘要

**返回数据：**
- `images` - 图表列表（base64编码）
- `goods_info` - 商品信息列表（包含标记日期）
- `marked_dates` - 标记日期字典
- `summary` - 基本信息统计

**特点：**
- 支持在折线图上用红点标记Video/Price标记的日期
- 在图片上方显示商品信息和标记日期
- 自动处理日期类型转换

---

### 7. `function4_manual_update.py` - 功能4：手动更新记录

**作用：** 实现手动更新记录功能，便捷更新Reason、Video、Price字段

**主要功能：**
- `manual_update_reason(goods_id, date_label, reason)` - 手动更新Reason字段
- `manual_update_video(goods_id, date_label)` - 手动更新Video字段为1
- `manual_update_price(goods_id, date_label)` - 手动更新Price字段为1
- `get_available_dates(goods_id)` - 获取指定goods_id可用的日期列表

**特点：**
- 更新前会检查日期是否存在
- 返回详细的成功/失败信息
- 支持获取可用日期列表（用于前端下拉选择）

---

### 8. `function5_data_filter.py` - 功能5：数据筛选

**作用：** 实现数据筛选功能，支持多条件筛选、排序、分页和导出

**主要功能：**

#### 核心功能函数
- `data_filter(filters, sort_field, sort_order, page, per_page, mean_mode, on_shelf_filter_mode)` - 数据筛选主函数
  - 支持多条件筛选（日期、曝光量、点击量、CTR）
  - 支持排序和分页
  - 支持均值模式和上架时间筛选模式
  - 处理NaN值和日期格式转换

- `export_filtered_data(filters, sort_field, sort_order, export_format, mean_mode, on_shelf_filter_mode)` - 导出筛选后的数据
  - 支持CSV和Excel格式
  - 支持均值模式和上架时间筛选模式
  - 自动生成带时间戳和模式标识的文件名

#### 均值计算函数
- `calculate_mean_by_goods_id(df, sort_field, sort_order)` - 按goods_id分组计算均值
  - 数值字段计算均值（保留2位小数）
  - 日期字段显示日期范围
  - Video/Price字段智能处理（空值显示None）
  - Status、Reason字段特殊处理

**筛选模式：**
- **普通模式**：按日期范围和其他条件筛选
- **均值模式**：按goods_id分组计算均值
- **上架时间筛选模式**：按商品上架日期筛选
- **模式叠加**：均值模式和上架时间筛选模式可以同时使用

**特点：**
- 支持复杂的筛选条件组合
- 自动处理NaN值，确保JSON可序列化
- 支持分页显示
- 支持多种导出格式

---

### 9. `plot_utils.py` - 图表绘制工具

**作用：** 提供所有图表绘制的工具函数

**主要功能：**

#### 工具函数
- `plot_to_base64(fig)` - 将matplotlib图表转换为base64字符串
  - 用于在Web页面中直接显示图片

#### 图表绘制函数
- `plot_goods_trend_double_axis(goods_id, df)` - 绘制商品曝光趋势图和动销条形图（双Y轴）
  - 左Y轴：曝光量（折线图）
  - 右Y轴：动销人数（条形图）
  - 自动设置日期刻度（最多16个）

- `plot_impressions_clicks_scatter(goods_id, df)` - 绘制曝光和点击的散点图
  - 计算相关性（Pearson相关系数）
  - 绘制3% CTR参考线
  - 显示相关系数和p值

- `plot_goods_batch(df, cols=3, marked_dates=None)` - 批量展示商品图（每行固定3个小图）
  - 支持传入标记日期，在折线图上用红点标记
  - 每个商品显示曝光量和动销人数
  - 自动处理日期格式和刻度

**特点：**
- 使用matplotlib非交互式后端（Agg）
- 支持中文字体显示
- 图表自动转换为base64编码
- 支持批量绘制和标记日期

---

## 📄 配置文件

### 10. `requirements.txt` - Python依赖包列表

**作用：** 列出项目所需的所有Python依赖包及其版本

**包含的包：**
- Flask 2.3.3 - Web框架
- pymysql 1.1.0 - MySQL数据库连接
- pandas 2.0.3 - 数据处理和分析
- numpy 1.24.3 - 数值计算
- matplotlib 3.7.2 - 图表绘制
- scipy 1.11.2 - 科学计算（用于相关性分析）
- openpyxl 3.1.2 - Excel文件读写

**安装方式：**
```bash
pip install -r requirements.txt
```

---

### 11. `app_config.json` - 应用配置文件

**作用：** 存储应用的配置信息（自动生成，不要手动编辑）

**包含内容：**
- Traffic数据库配置（host, port, user, password, database）
- Sales数据库配置（host, port, user, password, database）
- 当前选择的表名

**生成方式：**
- 首次运行时自动创建
- 通过Web界面配置后自动保存

---

## 🌐 前端文件

### 12. `templates/index.html` - 主页面模板

**作用：** Flask应用的HTML模板，定义页面结构和布局

**主要内容：**
- HTML页面结构
- Bootstrap样式框架引用
- 功能按钮和输入框
- 结果显示区域
- 配置模态框
- 导出选项模态框

**特点：**
- 响应式设计
- 使用Bootstrap 5框架
- 支持模态框交互

---

### 13. `static/css/style.css` - 样式文件

**作用：** 定义页面的自定义样式

**主要样式：**
- 页面布局样式
- 按钮样式
- 表格样式
- 图片容器样式
- 摘要框样式
- 响应式布局样式

---

### 14. `static/js/main.js` - 前端交互逻辑

**作用：** 实现所有前端交互功能，包括API调用、数据展示、用户交互

**主要功能：**

#### 页面切换函数
- `showFunction1()` - 显示功能1界面
- `showFunction2()` - 显示功能2界面
- `showFunction3()` - 显示功能3界面
- `showFunction4()` - 显示功能4界面
- `showFunction5()` - 显示功能5界面

#### 功能1相关函数
- `doQuickSearch()` - 执行快速查找
- 显示趋势图和散点图
- 显示数据摘要

#### 功能2相关函数
- `doDynamicManagement()` - 执行动销品管理分析
- `refreshStatusData()` - 刷新Status数据（完整刷新）
- `quickRefreshStatusData()` - 快速刷新Status数据（刷新所有动销品在昨天的数据）
- `displayFunction2Result(data, analysisTime, fromCache)` - 显示功能2结果
  - 显示前一天上升期、计算上升期、实际上升期
  - 显示各分类统计和goods_id列表
- `displayFunction2ResultFromCache(data)` - 从缓存显示功能2结果
- `clearFunction2Cache()` - 清除功能2缓存
- `exportFunction2Data()` - 导出功能2数据
- `showExportFunction2Modal()` - 显示导出选项模态框
- `toggleFunction2Help(id)` - 切换功能说明的显示/隐藏

#### 功能3相关函数
- `doOptimization(fieldName)` - 执行优化效果数据查询
- 显示图表和商品信息

#### 功能4相关函数
- `updateReason()` - 更新Reason字段
- `updateVideo()` - 更新Video字段
- `updatePrice()` - 更新Price字段
- `loadAvailableDates()` - 加载可用日期列表
- `useYesterdayDate()` - 使用昨天日期

#### 功能5相关函数
- `doDataFilter()` - 执行数据筛选
- `exportFilteredData()` - 导出筛选数据
- 支持均值模式和上架时间筛选模式

#### 配置相关函数
- `loadConfig()` - 加载配置
- `saveConfig()` - 保存配置
- `showConfigModal()` - 显示配置模态框

#### 表管理函数
- `setTable()` - 设置当前表
- `loadTables()` - 加载可用表列表

#### 工具函数
- `toggleSpecialNotes(id)` - 切换特殊说明的显示/隐藏

**特点：**
- 使用Fetch API进行异步请求
- 支持结果缓存（sessionStorage）
- 自动处理错误和异常
- 支持文件下载

---

## 📁 目录说明

### 15. `History_Dynamic/` - 功能2历史记录目录

**作用：** 存储功能2（动销品管理）的分析历史记录

**文件格式：**
- 文件名：`日期_表名.txt`（如：`2025-12-01_ROA1_NL.txt`）
- 内容：分析结果的文本记录
  - 统计信息（包括前一天上升期、计算上升期、实际上升期）
  - 各分类的具体goods_id列表（新增上升期、新增非上升期、更新为上升期、由非上升期重回上升期、由上升期到非上升期）
  - 计算上升期和实际上升期的差值goods_id
  - 上升期和非上升期商品的详细信息
- 保存规则：
  - 有新增商品时：自动覆盖文件
  - 无新增商品且文件已存在：跳过保存

**用途：**
- 记录每次分析的结果
- 便于追溯历史数据
- 支持离线查看

---

### 16. `Cache_Dynamic/` - 功能2缓存目录

**作用：** 存储功能2（动销品管理）的分析结果缓存

**文件格式：**
- 文件名：`表名_日期.json`（如：`FR_2025-12-16.json`）
- 内容：分析结果的JSON格式缓存
  - 统计信息（包括前一天上升期、计算上升期、实际上升期、各分类统计）
  - 上升期商品信息（goods_info、summary）
  - 非上升期商品信息（goods_info、summary）
  - 分析耗时
- **注意**：缓存不包含图片数据（base64图片太大）

**用途：**
- 加速重复分析（非缓存模式时重新分析）
- 减少数据库查询次数
- 提升用户体验

**缓存机制：**
- 分析结果自动缓存
- 非缓存模式会覆盖原有缓存
- 前端sessionStorage也缓存文本数据（不包含图片）

---

### 17. `History_Version/` - 历史版本备份目录

**作用：** 存储项目的历史版本备份

**目录结构：**
- `v1.0/` - 版本1.0的完整备份
- `v1.1/` - 版本1.1的完整备份
- `v1.3/` - 版本1.3的完整备份
- `v1.4/` - 版本1.4的完整备份

**每个版本包含：**
- 所有Python源代码文件
- 前端文件（HTML、CSS、JS）
- 配置文件
- README文档

**用途：**
- 版本回滚
- 功能对比
- 代码历史追踪

---

## 📚 文档文件

### 18. `README.md` - 项目使用说明文档

**作用：** 项目的完整使用说明文档

**主要内容：**
- 项目简介
- 系统要求
- 安装步骤
- 配置说明
- 功能使用指南（5个功能的详细说明）
- 技术架构
- 数据库表结构
- API接口说明
- 注意事项
- 常见问题
- 更新日志

**用途：**
- 用户使用指南
- 功能说明文档
- 问题排查参考

---

## 🔗 文件依赖关系

### 核心依赖链

```
app.py
├── config.py (配置管理)
├── db_utils.py (数据库工具)
│   └── config.py (获取数据库配置)
├── function1_quick_search.py
│   ├── db_utils.py (获取商品数据)
│   └── plot_utils.py (绘制图表)
├── function2_dynamic_management.py
│   ├── db_utils.py (数据库操作)
│   └── plot_utils.py (绘制图表)
├── function3_optimization.py
│   ├── db_utils.py (获取优化数据)
│   └── plot_utils.py (绘制图表，支持标记日期)
├── function4_manual_update.py
│   └── db_utils.py (更新数据)
└── function5_data_filter.py
    └── db_utils.py (获取筛选数据)

templates/index.html
└── static/js/main.js (前端逻辑)
    └── static/css/style.css (样式)
```

---

## 📝 文件修改注意事项

### 修改后端文件时：
1. **app.py** - 修改路由后需要重启Flask应用
2. **db_utils.py** - 修改数据库操作函数会影响所有功能模块
3. **config.py** - 修改配置格式需要同步更新前端配置界面
4. **功能模块** - 修改函数签名需要同步更新app.py中的调用

### 修改前端文件时：
1. **index.html** - 修改HTML结构需要确保JavaScript选择器匹配
2. **main.js** - 修改API调用需要确保后端接口匹配
3. **style.css** - 修改样式需要确保不影响现有布局

### 添加新功能时：
1. 创建新的功能模块文件（如`function6_xxx.py`）
2. 在`app.py`中添加新的路由
3. 在`main.js`中添加前端交互函数
4. 在`index.html`中添加功能按钮
5. 更新`README.md`文档

---

## 🎯 总结

本项目采用模块化设计，每个文件职责明确：

- **app.py** - 路由和请求处理
- **config.py** - 配置管理
- **db_utils.py** - 数据库操作
- **functionX_xxx.py** - 各功能模块
- **plot_utils.py** - 图表绘制
- **前端文件** - 用户界面和交互

这种设计使得代码结构清晰，易于维护和扩展。

---

**文档版本：** v2.0.0
**最后更新：** 2025-01-20

